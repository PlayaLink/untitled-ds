# Implementation Plan: Unified Design System with Figma Code Connect

**Generated by:** Claude Opus 4.5 (claude-opus-4-5-20251101)
**Date:** 2026-01-08

---

## Executive Summary

This plan creates a **BARE MINIMUM** design system setup with:
- Storybook 8 for component documentation
- Figma Code Connect for design-code parity
- Untitled UI as the component source (stripped down)
- Vite as the build tool (simpler than alternatives)

**Total new files: 7** (the absolute minimum for this stack)

---

## Analysis of Sonnet 4.5 Plan

The Sonnet 4.5 plan was well-structured but had several issues:

| Issue | Impact |
|-------|--------|
| Tailwind 4.1 configuration is outdated | Styles won't work in Storybook |
| Missing `@tailwindcss/vite` plugin in Storybook | Critical - Tailwind 4 requires this |
| `tsconfig.node.json` is unnecessary | Extra complexity |
| `@storybook/manager.ts` is optional | Not essential |
| Missing `cx.ts` utility | Untitled UI components depend on this |
| Using `clsx` instead of `tailwind-merge` | Doesn't match Untitled UI pattern |
| 11 files to create vs 7 actually needed | More complexity than necessary |

---

## What Needs to Be Created (7 files)

| File | Purpose | Why Essential |
|------|---------|---------------|
| `package.json` | Dependencies & scripts | Foundation |
| `tsconfig.json` | TypeScript config | Type safety |
| `figma.config.json` | Code Connect config | Figma sync |
| `.storybook/main.ts` | Storybook + Tailwind 4 | Critical integration |
| `.storybook/preview.ts` | Global styles | CSS entry |
| `src/styles/globals.css` | Tailwind entry | Styling |
| `src/utils/cx.ts` | Class merge utility | Untitled UI dependency |

## What Already Exists (keep as-is)

| File | Status |
|------|--------|
| `tailwind.config.js` | EXISTS - Use via `@config` directive |
| `tokens/primitives.tokens.json` | EXISTS |
| `src/styles/tokens.css` | EXISTS |
| `scripts/build-tokens.js` | EXISTS |

---

## Phase 1: Project Foundation

### 1.1 package.json (MINIMAL)

```json
{
  "name": "unified-ds",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "storybook dev -p 6006",
    "build": "storybook build",
    "build:tokens": "node scripts/build-tokens.js",
    "figma:publish": "figma connect publish"
  },
  "dependencies": {
    "react": "^19.1.0",
    "react-dom": "^19.1.0",
    "react-aria-components": "^1.9.0",
    "tailwind-merge": "^3.0.0"
  },
  "devDependencies": {
    "@figma/code-connect": "^1.2.0",
    "@storybook/addon-essentials": "^8.5.0",
    "@storybook/react": "^8.5.0",
    "@storybook/react-vite": "^8.5.0",
    "@tailwindcss/vite": "^4.1.0",
    "@types/react": "^19.1.0",
    "@types/react-dom": "^19.1.0",
    "@vitejs/plugin-react": "^4.3.0",
    "storybook": "^8.5.0",
    "tailwindcss": "^4.1.0",
    "typescript": "^5.8.0",
    "vite": "^6.0.0"
  }
}
```

**Key differences from Sonnet plan:**
- `tailwind-merge` instead of `clsx` (Untitled UI pattern)
- `@tailwindcss/vite` added (CRITICAL for Tailwind 4)
- Removed `@storybook/addon-links` (not essential)
- Removed `@storybook/blocks` (auto-included)

### 1.2 tsconfig.json (MINIMAL)

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "moduleResolution": "bundler",
    "jsx": "react-jsx",
    "strict": true,
    "noEmit": true,
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src", ".storybook"]
}
```

**Removed from Sonnet plan:**
- `tsconfig.node.json` - Not needed
- `useDefineForClassFields` - Default is fine
- `allowImportingTsExtensions` - Not needed
- `noUnusedLocals/Parameters` - Too strict initially

### 1.3 figma.config.json (SIMPLIFIED)

```json
{
  "codeConnect": {
    "include": ["src/components/**/*.figma.tsx"],
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

**Simplified from Sonnet plan:**
- Removed `documentUrlSubstitutions` - Only needed for multi-file setups
- Kept path aliases to match tsconfig

### 1.4 .storybook/main.ts (CRITICAL - Tailwind 4.1 Integration)

```typescript
import type { StorybookConfig } from '@storybook/react-vite'
import { mergeConfig } from 'vite'
import { resolve } from 'path'

const config: StorybookConfig = {
  stories: ['../src/components/**/*.stories.tsx'],
  addons: ['@storybook/addon-essentials'],
  framework: {
    name: '@storybook/react-vite',
    options: {},
  },
  viteFinal: async (config) => {
    const { default: tailwindcss } = await import('@tailwindcss/vite')
    return mergeConfig(config, {
      plugins: [tailwindcss()],
      resolve: {
        alias: {
          '@': resolve(__dirname, '../src'),
        },
      },
    })
  },
}

export default config
```

**CRITICAL FIX:** Uses `@tailwindcss/vite` plugin via dynamic import in `viteFinal`. This is **required** for Tailwind 4.1 to work in Storybook. The Sonnet plan missed this.

### 1.5 .storybook/preview.ts (SIMPLIFIED)

```typescript
import type { Preview } from '@storybook/react'
import '../src/styles/globals.css'

const preview: Preview = {
  parameters: {
    layout: 'centered',
  },
}

export default preview
```

**Simplified:**
- Removed matchers config (defaults are fine)
- Single CSS import
- Removed `.storybook/manager.ts` entirely (optional theming)

### 1.6 src/styles/globals.css (Tailwind 4 Syntax)

```css
@import 'tailwindcss';
@config '../../tailwind.config.js';
@import './tokens.css';
```

**Key insight:** Tailwind 4 can still read the existing `tailwind.config.js` using the `@config` directive. This avoids a complex migration while keeping the v4 plugin benefits.

### 1.7 src/utils/cx.ts (Untitled UI Dependency)

```typescript
import { twMerge } from 'tailwind-merge'

export function cx(...classes: (string | undefined | null | false)[]): string {
  return twMerge(classes.filter(Boolean).join(' '))
}
```

**Why this is needed:** This utility is used throughout Untitled UI components. Without it, imported components will fail. The Sonnet plan missed this.

---

## Phase 2: Component Pattern

### File Structure Per Component

```
src/components/button/
├── button.tsx           # Component code
├── button.stories.tsx   # Storybook stories
└── button.figma.tsx     # Code Connect mapping
```

### 2.1 Component Template: button.tsx

```tsx
import { Button as AriaButton, type ButtonProps as AriaButtonProps } from 'react-aria-components'
import { cx } from '@/utils/cx'

export interface ButtonProps extends Omit<AriaButtonProps, 'className'> {
  variant?: 'primary' | 'secondary'
  size?: 'sm' | 'md' | 'lg'
}

export function Button({
  variant = 'primary',
  size = 'md',
  children,
  ...props
}: ButtonProps) {
  return (
    <AriaButton
      className={cx(
        'inline-flex items-center justify-center rounded-md font-semibold transition-colors',
        'focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-600',
        size === 'sm' && 'px-3 py-1.5 text-sm',
        size === 'md' && 'px-4 py-2 text-md',
        size === 'lg' && 'px-5 py-2.5 text-lg',
        variant === 'primary' && 'bg-brand-600 text-white hover:bg-brand-700',
        variant === 'secondary' && 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50',
      )}
      {...props}
    >
      {children}
    </AriaButton>
  )
}
```

**Uses `cx()` instead of `clsx()`** - Matches Untitled UI pattern.

### 2.2 Story Template: button.stories.tsx

```tsx
import type { Meta, StoryObj } from '@storybook/react'
import { Button } from './button'

const meta: Meta<typeof Button> = {
  title: 'Components/Button',
  component: Button,
  tags: ['autodocs'],
  argTypes: {
    variant: { control: 'select', options: ['primary', 'secondary'] },
    size: { control: 'select', options: ['sm', 'md', 'lg'] },
  },
}

export default meta
type Story = StoryObj<typeof Button>

export const Primary: Story = {
  args: { children: 'Button', variant: 'primary' },
}

export const Secondary: Story = {
  args: { children: 'Button', variant: 'secondary' },
}

export const Sizes: Story = {
  render: () => (
    <div className="flex items-center gap-4">
      <Button size="sm">Small</Button>
      <Button size="md">Medium</Button>
      <Button size="lg">Large</Button>
    </div>
  ),
}

// LAST PAGE - Figma Link (REQUIRED per user specs)
export const Figma: Story = {
  render: () => (
    <div className="flex flex-col items-center gap-6 p-8">
      <div className="text-center">
        <h2 className="text-xl font-semibold mb-2">Figma Source</h2>
        <p className="text-gray-600 mb-4">
          This component was built from the following Figma design
        </p>
      </div>
      <a
        href="https://www.figma.com/design/99BhJBqUTbouPjng6udcbz/?node-id=REPLACE_WITH_NODE_ID"
        target="_blank"
        rel="noopener noreferrer"
        className="inline-flex items-center gap-2 px-6 py-3 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors font-medium"
      >
        View in Figma
      </a>
    </div>
  ),
}
```

### 2.3 Code Connect Template: button.figma.tsx

```tsx
import figma from '@figma/code-connect'
import { Button } from './button'

figma.connect(
  Button,
  'https://www.figma.com/design/99BhJBqUTbouPjng6udcbz/?node-id=REPLACE_WITH_NODE_ID',
  {
    props: {
      variant: figma.enum('Variant', {
        Primary: 'primary',
        Secondary: 'secondary',
      }),
      size: figma.enum('Size', {
        Small: 'sm',
        Medium: 'md',
        Large: 'lg',
      }),
      children: figma.string('Label'),
    },
    example: ({ variant, size, children }) => (
      <Button variant={variant} size={size}>
        {children}
      </Button>
    ),
  }
)
```

---

## Phase 3: Implementation Steps

### Step 1: Create Files (In Order)

```bash
# 1. package.json
# 2. tsconfig.json
# 3. figma.config.json
# 4. .storybook/main.ts
# 5. .storybook/preview.ts
# 6. src/styles/globals.css
# 7. src/utils/cx.ts
```

### Step 2: Install Dependencies

```bash
npm install
```

### Step 3: Authenticate (One-Time)

```bash
# Untitled UI (for PRO components)
npx untitledui@latest login

# Figma Code Connect (set env var)
export FIGMA_ACCESS_TOKEN=your_token_here
# Requires: Code Connect Write + File content Read scopes
```

### Step 4: Test Storybook

```bash
npm run dev
# Opens at http://localhost:6006
```

### Step 5: Add First Component

```bash
npx untitledui@latest add button --path src/components
# Then strip code to match simplified Figma
```

### Step 6: Publish to Code Connect

```bash
npm run figma:publish
# Verify in Figma Dev Mode
```

---

## Per-Component Workflow (Repeatable)

### Checklist for Each Component

#### Step 1: Figma Preparation (User)
- [ ] Simplify component in Figma
- [ ] Remove excess variants/properties
- [ ] Note the node-id from URL
- [ ] Share Figma URL with Claude

#### Step 2: Verification (Claude)
- [ ] Fetch Figma data via MCP
- [ ] List all remaining properties and variants
- [ ] Verify no orphaned variants
- [ ] Confirm 1:1 mapping is possible

#### Step 3: Import & Strip
```bash
npx untitledui@latest add [component] --path src/components
```
- [ ] Review imported code
- [ ] Remove unused variant code
- [ ] Match props to Figma exactly
- [ ] Use `cx()` for class merging

#### Step 4: Create Story
- [ ] Create `[component].stories.tsx`
- [ ] Add story for each variant
- [ ] Add Figma tab as LAST story
- [ ] Enable autodocs

#### Step 5: Create Code Connect
- [ ] Create `[component].figma.tsx`
- [ ] Map Figma properties to props (case-sensitive!)
- [ ] Add example rendering

#### Step 6: Test
```bash
npm run dev
```
- [ ] All stories render
- [ ] Props controls work
- [ ] Figma link works
- [ ] Styles apply correctly

#### Step 7: Publish
```bash
npm run figma:publish
```
- [ ] Verify in Figma Dev Mode
- [ ] Code snippet appears correctly

#### Step 8: Commit
```bash
git add src/components/[component]
git commit -m "feat(components): add [component]

- Import from Untitled UI
- Strip to match Figma design
- Add Storybook stories
- Configure Code Connect"
```

---

## Project Structure After Setup

```
unified-ds/
├── .storybook/
│   ├── main.ts                    # NEW
│   └── preview.ts                 # NEW
│
├── src/
│   ├── components/
│   │   └── button/                # Per-component (example)
│   │       ├── button.tsx
│   │       ├── button.stories.tsx
│   │       └── button.figma.tsx
│   │
│   ├── styles/
│   │   ├── globals.css            # NEW
│   │   └── tokens.css             # EXISTS
│   │
│   └── utils/
│       └── cx.ts                  # NEW
│
├── tokens/
│   └── primitives.tokens.json     # EXISTS
│
├── scripts/
│   └── build-tokens.js            # EXISTS
│
├── package.json                   # NEW
├── tsconfig.json                  # NEW
├── figma.config.json              # NEW
├── tailwind.config.js             # EXISTS (use via @config)
└── CLAUDE.md                      # EXISTS
```

**Total: 7 new files** (vs 11 in Sonnet plan)

---

## What Could Go Wrong & Prevention

| Issue | Symptom | Prevention |
|-------|---------|------------|
| Tailwind styles not working | Components unstyled | Use `@tailwindcss/vite` in viteFinal |
| Path aliases not resolving | Import errors | Match paths in tsconfig AND viteFinal |
| Code Connect not finding files | Publish fails | Check `include` glob in figma.config.json |
| Untitled UI components too complex | Too many variants | Expected - strip after import |
| Figma property names don't match | Mapping fails | Property names are case-sensitive |
| `cx` is not defined | Runtime error | Create `src/utils/cx.ts` first |
| Tailwind config not found | No styles | Use `@config` directive in globals.css |

---

## Critical Success Factors

1. **Tailwind 4.1 + Storybook integration** - MUST use `@tailwindcss/vite` in viteFinal
2. **Path aliases consistency** - Same in tsconfig.json AND Storybook viteFinal
3. **`cx.ts` utility exists** - Required for Untitled UI components
4. **`@config` directive** - Links Tailwind 4 to existing tailwind.config.js
5. **Code Connect authentication** - Token needs Code Connect Write + File content Read scopes
6. **Figma property mapping** - Names must match exactly (case-sensitive)

---

## Verification Steps

After implementation, verify:

1. ✅ `npm run dev` opens Storybook at http://localhost:6006
2. ✅ Component renders with correct styles
3. ✅ Props controls work in Storybook UI
4. ✅ Figma tab shows and links correctly
5. ✅ `npm run figma:publish` succeeds
6. ✅ Code snippet appears in Figma Dev Mode
7. ✅ TypeScript has no errors
8. ✅ Path aliases resolve (`@/utils/cx`)

---

## Future: Publish to Vercel (Later Phase)

```bash
# Build Storybook
npm run build

# Deploy via Vercel MCP
# Build command: npm run build
# Output directory: storybook-static
# Install command: npm install
```

---

## Key Differences from Sonnet 4.5 Plan

| Aspect | Sonnet 4.5 | Opus 4.5 |
|--------|------------|----------|
| Config files | 11 | 7 |
| Tailwind 4 integration | Missing @tailwindcss/vite | Correct integration |
| Class utility | clsx | tailwind-merge + cx.ts |
| tsconfig.node.json | Included | Removed (unnecessary) |
| Storybook manager.ts | Included | Removed (optional) |
| @config directive | Not mentioned | Used to keep existing config |
| cx.ts utility | Missing | Included (critical) |

---

## Commit Message Format (per .cursor/rules)

```
<type>: <message title>

- Bullet point 1
- Bullet point 2
```

**Rules:**
- NO emojis
- NO "Co-Authored-By: Claude"
- NO promotional footers
- Types: feat, fix, chore, docs, refactor, test, style, perf
- Title: lowercase, max 50 chars, no period

---

## Success Criteria

✅ `npm run dev` shows Storybook with component
✅ Tailwind styles apply correctly (design tokens work)
✅ Props controls work in Storybook
✅ Figma tab links to design
✅ `npm run figma:publish` succeeds
✅ Figma Dev Mode shows code snippets
✅ Ready to add more components following the pattern
