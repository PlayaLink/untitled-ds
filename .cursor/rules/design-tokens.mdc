---
alwaysApply: false
---
# Design Token Architecture

## Token Flow

```
Figma Variables → Export Plugin → tokens/all-figma.tokens.json
                                         ↓
                               npm run build:tokens
                                         ↓
                    ┌────────────────────┴────────────────────┐
                    ↓                                         ↓
        src/styles/tokens.css                    src/styles/tailwind-tokens.cjs
        (CSS variables + dark mode)              (Tailwind theme values)
                                                          ↓
                                               tailwind.config.cjs (imports generated tokens)
```

**Single source of truth:** Figma exports 786 variables from 7 collections (Primitives, Light mode, Dark mode, Typography, Spacing, Widths/Radius, Containers).

## Updating Tokens from Figma

When tokens change in Figma:
1. Export via Plugins → Development → Variables Export
2. Save JSON to `tokens/all-figma.tokens.json`
3. Run `npm run build:tokens` to regenerate CSS variables and Tailwind config

## Generated Files

| File | Purpose |
|------|---------|
| `src/styles/tokens.css` | CSS custom properties with `:root` (light) and `[data-theme="dark"]` overrides |
| `src/styles/tailwind-tokens.cjs` | Tailwind theme values (colors, spacing, radius, widths, typography) |

## Dark Mode

Toggle dark mode by setting the `data-theme` attribute:
```js
document.documentElement.dataset.theme = "dark"  // Enable dark mode
document.documentElement.dataset.theme = "light" // Force light mode
// Remove attribute to follow system preference
```

The generated CSS includes `@media (prefers-color-scheme: dark)` for automatic system preference support.

## Styling Conventions

- **Tailwind 4** with `@import 'tailwindcss'` syntax in `src/styles/globals.css`
- **Config reference:** `@config '../../tailwind.config.cjs'`
- **Semantic aliases:** `primary` (brand), `destructive` (error)

## Semantic vs Primitive Tokens (Dark Mode Support)

**CRITICAL:** For dark mode to work, components MUST use semantic tokens instead of primitive color scales for grayscale colors.

### ❌ DON'T use primitive gray tokens (won't respond to dark mode):
```typescript
// These are static values that won't change with theme
'text-gray-900'    // Always #181d27
'text-gray-700'    // Always #414651
'text-gray-500'    // Always #717680
'bg-gray-50'       // Always #fafafa
'bg-gray-100'      // Always #f5f5f5
'border-gray-300'  // Always #d5d7da
'ring-gray-300'    // Always #d5d7da
```

### ✅ DO use semantic tokens (responds to dark mode):
```typescript
// These use CSS variables that change with [data-theme="dark"]
'text-primary'           // Main text (gray-900 in light, gray-dark-50 in dark)
'text-secondary'         // Secondary text (gray-700 in light, gray-dark-300 in dark)
'text-tertiary'          // Muted text (gray-600 in light, gray-dark-400 in dark)
'text-quaternary'        // Very muted (gray-500 in light, gray-dark-400 in dark)
'text-disabled'          // Disabled text
'text-placeholder'       // Placeholder text

'bg-primary'             // Main background (white in light, gray-dark-950 in dark)
'bg-secondary'           // Subtle background (gray-50 in light, gray-dark-900 in dark)
'bg-tertiary'            // Slightly darker (gray-100 in light, gray-dark-800 in dark)
'bg-primary-hover'       // Hover state for primary bg
'bg-secondary-hover'     // Hover state for secondary bg

'border-primary'         // Main borders (gray-300 in light, gray-dark-700 in dark)
'border-secondary'       // Subtle borders (gray-200 in light, gray-dark-800 in dark)
'ring-border-primary'    // For ring-* utilities
'ring-border-secondary'  // For ring-* utilities
```

### Mapping Reference (Light → Semantic):
| Primitive | Semantic Token |
|-----------|----------------|
| `text-gray-900` | `text-primary` |
| `text-gray-700` | `text-secondary` |
| `text-gray-600` | `text-tertiary` |
| `text-gray-500` | `text-tertiary` or `text-quaternary` |
| `text-gray-400` | `text-disabled` |
| `bg-base-white` | `bg-primary` |
| `bg-gray-50` | `bg-secondary` |
| `bg-gray-100` | `bg-tertiary` |
| `border-gray-300` | `border-primary` |
| `border-gray-200` | `border-secondary` |
| `ring-gray-300` | `ring-border-primary` |
| `ring-gray-200` | `ring-border-secondary` |

### When to Keep Primitives:
- **Colored badges/pills** (brand, error, warning, success colors) - these should be consistent across themes
- **Brand colors** (brand-500, brand-600) - intentionally static
- **Status colors** (error-500, success-500) - intentionally static

## How Dark Mode Works

The dark mode system uses two coordinated files:

1. **`tokens.css`** - Defines CSS custom properties with light mode defaults in `:root` and dark mode overrides in `[data-theme="dark"]`
2. **`tailwind-tokens.cjs`** - Exports semantic colors as CSS variable references (e.g., `primary: 'var(--color-border-primary)'`)

When Tailwind generates utilities like `ring-border-primary`, they reference the CSS variables which automatically respond to the theme attribute.

**Important:** Do NOT add semantic colors to `@theme` blocks in `globals.css` - this creates circular references that break the dark mode cascade.

## Available Color Utilities

All these Tailwind utilities support semantic tokens for dark mode:

| Utility | Example | Use Case |
|---------|---------|----------|
| `text-*` | `text-primary`, `text-secondary` | Text color |
| `bg-*` | `bg-primary`, `bg-secondary` | Background color |
| `border-*` | `border-primary`, `border-secondary` | Border color |
| `ring-*` | `ring-border-primary`, `ring-border-error` | Focus rings, outlines |
| `fill-*` | `fill-fg-primary` | SVG fill color |
| `stroke-*` | `stroke-fg-primary` | SVG stroke color |
| `divide-*` | `divide-border-secondary` | Divider lines |
| `outline-*` | `outline-border-primary` | Outline color |
| `caret-*` | `caret-fg-primary` | Text cursor color |
| `accent-*` | `accent-bg-brand-primary` | Form accent color |

## Troubleshooting

### Dark Mode Not Working

1. **Check `data-theme` attribute**: Ensure `<html data-theme="dark">` is set
2. **Verify CSS variables exist**: In DevTools, check that `--color-border-primary` etc. are defined on `:root`
3. **Disable browser extensions**: Dark Reader and similar extensions override all colors and will break your design system's dark mode

### Browser Extension Interference

If colors look wrong or `box-shadow: none` appears unexpectedly, check for browser extensions like **Dark Reader** that modify page colors. These extensions:
- Override CSS custom properties
- Remove shadows
- Replace your carefully designed dark mode with their own

Add sites to extension exclusion lists when developing.

## Utilities

Use `cx()` from `@/cx` for className merging (wraps tailwind-merge).
